<?php

  # This script returns an Open Source Physics XML file that defines the current directory as a digital library collection
  # and video files and subdirectories it contains as library resources and sub-collections, respectively.
  # 
  # Files that are identified as resources include video files with extensions .mov, .mp4, .avi, .wmv, .flv  unless the file
  # name starts with "_. All subdirectories with resources are identified as collections unless their name starts with "_".
  #
  # You can specify whether to include subdirectories by setting "$includeSubdirectories" on line 154 to true or false.
  # 
  # You can provide a name and descriptive html page for this collection or any sub-collection by including an html file
  # with the same name as this php file with an added "_info" (e.g., "my_php_collection_info.html" to describe collections 
  # generated by "my_php_collection.php" or "my_php_collection.html") in the directory or subdirectory.
  # The name of the collection is set to the title of the descriptive html page, if any.
  # 
  # You can provide a descriptive html page for any video resource by including an html file with the same
  # name as the resource in the same directory (e.g., "my_video.html" to describe "my_video.trk").
  
  # compare end of $FullStr with $EndStr
  function endsWith($FullStr, $EndStr) {
    $StrLen = strlen($EndStr); // get the length of the end string
    $FullStrEnd = substr($FullStr, strlen($FullStr) - $StrLen); // get the same length substring from end of FullStr
    return $FullStrEnd == $EndStr; // compare
  }
  
  # gets the title from $htmltext (ie string between "<title>" and "</title>")
  function getTitle($htmltext){
	$x = explode('<title>', $htmltext);
	$y = explode('</title>', $x[1]);
	return $y[0];
  }

  # write a LibraryResource for a video file
  function writeVideoRecord($filename, $dir, $tab, $index, $collectionXML) { 

	$parts = explode('.', $filename);
    $name = $parts[0];    
	$indent = $tab . "  ";
	
	# write array index and class name
	$collectionXML = $collectionXML . $tab . '<property name="[' . $index . ']" type="object">' . "\n";
  	$collectionXML = $collectionXML . $tab . '<object class="org.opensourcephysics.tools.LibraryResource">' . "\n"; 
  	$collectionXML = $collectionXML . $indent . '<property name="name" type="string">' . $name . '</property>' . "\n"; 
  	if (file_exists($dir . "/" . $name . ".html")) {
		$collectionXML = $collectionXML . $indent . '<property name="html_path" type="string">' . $name . '.html</property>' . "\n";
	}
	
	# write type and target
	$collectionXML = $collectionXML . $indent . '<property name="type" type="string">' . "Video" . '</property>' . "\n";  
	$collectionXML = $collectionXML . $indent . '<property name="target" type="string">' . $filename . '</property>' . "\n";  
	$collectionXML = $collectionXML . $tab . '</object>' . "\n"; 
	$collectionXML = $collectionXML . $tab . '</property>' . "\n";
	return $collectionXML;
  }

  # write a LibraryCollection for videos and subdirectories
  function writeCollection($baseAddress, $dir, $tab) { 
	$indent = $tab . "  ";
    
    # get the name of this script file
	$currentfile = $_SERVER["PHP_SELF"];
	$parts = explode('/', $currentfile);
	$currentfile = $parts[count($parts) - 1];
	$parts = explode('.', $currentfile);
	$currentfilename = $parts[0];
  	$collectioninfofile = $currentfilename . "_info.html";
    
    # look for collection name
    $catname = '';	
	if (file_exists($dir . "/" . $collectioninfofile)) {
		$catname = getTitle(file_get_contents($dir . "/" . $collectioninfofile));
	}
	if ($catname=='' && $dir!='.') {
		$parts = explode('/', $dir);
		$catname = $parts[count($parts) - 1];
	}
	
	# create collection xml string
	$collectionXML = '';
	
	# write class baseAddress, name and info, if any
  	$collectionXML = $collectionXML . $tab . '<object class="org.opensourcephysics.tools.LibraryCollection">' . "\n"; 
    if ($catname!='') $collectionXML = $collectionXML . $indent . '<property name="name" type="string">' . $catname . '</property>' . "\n";
  	$collectionXML = $collectionXML . $indent . '<property name="base_path" type="string">' . $baseAddress . '</property>' . "\n";     
    if (file_exists($dir . "/" . $collectioninfofile)) $collectionXML = $collectionXML . $indent . '<property name="html_path" type="string">' . $collectioninfofile . '</property>' . "\n";
	
	# get the directory listing
    $dh = opendir($dir);
	while (false !== ($filename = readdir($dh))) $files[] = $filename;
	sort($files);
	
	$index = 0;
	$collectionXML = $collectionXML . $indent . '<property name="resources" type="array" class="[Lorg.opensourcephysics.tools.LibraryResource;">' . "\n"; 
    	
	# write video resources
	foreach($files as $filename) {
	  if ($filename=="." || $filename=="..") continue;
	  if ($filename[0]=="_") continue; // ignore files starting with '_'
	  
	  $path = $dir . "/" . $filename;
	  if (!is_dir($path)) {
		if (endsWith($filename,".mov") || endsWith($filename,".avi") || endsWith($filename,".wmv") || endsWith($filename,".mp4") || endsWith($filename,".flv")) {
		  $collectionXML = writeVideoRecord($filename, $dir, $indent . "  ", $index++, $collectionXML);
		}
	  }
	  
	}
    
	# specify whether to include subdirectories
	$includeSubdirectories = true;
    
	# write collections (subdirectories) if included (see above)
	if ($includeSubdirectories) foreach($files as $filename) {
	  if ($filename=="." || $filename=="..") continue;
	  if ($filename[0]=="_") continue; // ignore files starting with '_'
	  
	  $path = $dir . "/" . $filename;
	  if (is_dir($path)) {
		$nextCollection = writeCollection ($baseAddress . $filename . "/", $path, $indent . "  ");
				
		# add entry for the directory only if not empty
		if ($nextCollection!='') {
			$collectionXML = $collectionXML .  $indent . '  <property name="[' . $index++ . ']" type="object">' . "\n";
			$collectionXML = $collectionXML . $nextCollection;
			$collectionXML = $collectionXML .  $indent . '  </property>' . "\n";
		}
	  }
	}
	
	$elementZero = "[0]";
	$pos = strpos($collectionXML,$elementZero);

	if($pos===false && $tab!="") {
	 	return '';
	}
	
	$collectionXML = $collectionXML .  $indent . '</property>' . "\n";
	 
	$collectionXML = $collectionXML .  $tab . '</object>' . "\n"; 
	
	return $collectionXML;
	
  }

  $baseAddress =  "http://" . $_SERVER['SERVER_NAME'] . $_SERVER['REQUEST_URI'];
  $baseAddress = substr($baseAddress,0,strlen($baseAddress)-strlen(strrchr($baseAddress, "/"))+1);
  
  print '<?xml version="1.0" encoding="UTF-8"?>' . "\n";
  print writeCollection ($baseAddress,".","");
	
?>
